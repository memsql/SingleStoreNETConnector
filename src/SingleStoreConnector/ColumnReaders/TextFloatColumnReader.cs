using System.Buffers.Text;
using System.Text;
using SingleStoreConnector.Protocol.Payloads;
using SingleStoreConnector.Utilities;

namespace SingleStoreConnector.ColumnReaders;

internal sealed class TextFloatColumnReader : ColumnReader
{
	public static TextFloatColumnReader Instance { get; } = new();

	public override object ReadValue(ReadOnlySpan<byte> data, ColumnDefinitionPayload columnDefinition)
	{
		if (Utf8Parser.TryParse(data, out float floatValue, out var floatBytesConsumed) && floatBytesConsumed == data.Length)
			return floatValue;
		if (data.SequenceEqual("-inf"u8))
			return float.NegativeInfinity;
		if (data.SequenceEqual("inf"u8))
			return float.PositiveInfinity;
		if (data.SequenceEqual("nan"u8))
			return float.NaN;
		throw new FormatException($"Couldn't parse value as float: {Encoding.UTF8.GetString(data)}");
	}
}
